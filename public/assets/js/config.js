import { getLocationById } from './locations.js';

class ConfigGenerator {
    generateKeys() {
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        const privateKey = btoa(String.fromCharCode.apply(null, array));
        return { privateKey };
    }

    async generateConfigFromAPI(token, options) {
        const response = await fetch('/api/config/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(options)
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to generate configuration');
        }

        return data;
    }

    generateConfig(options) {
        const {
            locationId,
            privateKey,
            address = '10.0.0.2/32',
            dnsType = 'both',
            allowedIPs = '0.0.0.0/0, ::/0',
            persistentKeepalive = 25
        } = options;

        const location = getLocationById(locationId);
        if (!location) {
            throw new Error('Invalid location selected');
        }

        let dns = [];
        if (dnsType === 'ipv4' || dnsType === 'both') {
            dns = dns.concat(location.dns.ipv4);
        }
        if (dnsType === 'ipv6' || dnsType === 'both') {
            dns = dns.concat(location.dns.ipv6);
        }

        const config = `[Interface]
# Generated by WireGuard DNS Generator
# Location: ${location.name} (${location.city})
PrivateKey = ${privateKey}
Address = ${address}
DNS = ${dns.join(', ')}

[Peer]
# Replace with your server's public key
PublicKey = YOUR_SERVER_PUBLIC_KEY
Endpoint = ${location.endpoint}
AllowedIPs = ${allowedIPs}
PersistentKeepalive = ${persistentKeepalive}`;

        return {
            config,
            location,
            dnsServers: dns
        };
    }

    async saveConfig(token, configData) {
        const response = await fetch('/api/config/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(configData)
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.error || 'Failed to save configuration');
        }

        return data;
    }

    downloadConfig(config, filename = 'wireguard.conf') {
        const blob = new Blob([config], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    copyToClipboard(text) {
        return navigator.clipboard.writeText(text);
    }
}

const configGenerator = new ConfigGenerator();
export default configGenerator;
