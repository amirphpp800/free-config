<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ابزارها - ROOTLeaker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/public/styles.css">
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <a href="/" class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-shield-halved"></i>
                        </div>
                        <div class="logo-text">
                            <h1>ROOTLeaker</h1>
                            <span>ابزارهای امنیتی</span>
                        </div>
                    </a>
                    
                    <nav class="main-nav">
                        <a href="/" class="nav-link"><i class="fas fa-home"></i> خانه</a>
                        <a href="/dns.html" class="nav-link"><i class="fas fa-globe"></i> DNS</a>
                        <a href="/wireguard.html" class="nav-link"><i class="fas fa-network-wired"></i> WireGuard</a>
                        <a href="/tools.html" class="nav-link active"><i class="fas fa-toolbox"></i> ابزارها</a>
                    </nav>
                    
                    <div class="header-actions">
                        <a href="https://t.me/ROOTLeaker" target="_blank" class="btn btn-telegram">
                            <i class="fab fa-telegram"></i>
                            کانال تلگرام
                        </a>
                        <div id="auth-buttons">
                            <button class="btn btn-outline" onclick="showAuthModal()">
                                <i class="fas fa-sign-in-alt"></i>
                                ورود
                            </button>
                        </div>
                        <div id="user-menu" class="hidden">
                            <div class="user-badge">
                                <i class="fas fa-user-circle"></i>
                                <span id="user-display"></span>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="announcement-bar" id="announcement-bar">
            <div class="container">
                <i class="fas fa-bullhorn"></i>
                <span id="announcement-text"></span>
                <button class="close-btn" onclick="closeAnnouncement()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <main class="main">
            <div class="container page-content">
                <div class="page-header">
                    <div class="page-icon tools">
                        <img src="/images/tool.webp" alt="Tools" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius);">
                    </div>
                    <div class="page-info">
                        <h1>ابزارهای کاربردی</h1>
                        <p>مجموعه ابزارهای مفید برای کار با شبکه و امنیت</p>
                    </div>
                </div>

                <div class="tools-grid">
                    <div class="tool-card">
                        <div class="tool-icon">
                            <i class="fas fa-globe-americas"></i>
                        </div>
                        <h3>بررسی IP</h3>
                        <p>نمایش آی‌پی فعلی شما و اطلاعات موقعیت مکانی</p>
                        <button class="btn btn-primary" onclick="checkMyIP()">
                            <i class="fas fa-search"></i>
                            بررسی
                        </button>
                    </div>

                    <div class="tool-card">
                        <div class="tool-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <h3>تست سرعت DNS</h3>
                        <p>بررسی سرعت پاسخ‌دهی سرورهای DNS مختلف</p>
                        <button class="btn btn-primary" onclick="testDnsSpeed()">
                            <i class="fas fa-bolt"></i>
                            تست سرعت
                        </button>
                    </div>

                    <div class="tool-card">
                        <div class="tool-icon">
                            <i class="fas fa-shield-virus"></i>
                        </div>
                        <h3>بررسی نشتی DNS</h3>
                        <p>تست امنیت و بررسی نشتی درخواست‌های DNS</p>
                        <button class="btn btn-primary" onclick="checkDnsLeak()">
                            <i class="fas fa-user-secret"></i>
                            بررسی
                        </button>
                    </div>

                    <div class="tool-card">
                        <div class="tool-icon">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <h3>ساخت QR Code</h3>
                        <p>تبدیل کانفیگ WireGuard به کد QR برای اسکن آسان</p>
                        <button class="btn btn-primary" onclick="showQrGenerator()">
                            <i class="fas fa-plus"></i>
                            ساخت
                        </button>
                    </div>

                    <div class="tool-card">
                        <div class="tool-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h3>بررسی پینگ</h3>
                        <p>اندازه‌گیری زمان پاسخ‌دهی سرورهای مختلف</p>
                        <button class="btn btn-primary" onclick="checkPing()">
                            <i class="fas fa-signal"></i>
                            بررسی
                        </button>
                    </div>

                    <div class="tool-card">
                        <div class="tool-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3>راهنمای نصب</h3>
                        <p>آموزش نصب و راه‌اندازی WireGuard در دستگاه‌های مختلف</p>
                        <button class="btn btn-primary" onclick="showGuide()">
                            <i class="fas fa-graduation-cap"></i>
                            مشاهده
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <div class="footer-brand">
                        <i class="fas fa-shield-halved"></i>
                        <span>ROOTLeaker</span>
                    </div>
                    <div class="footer-links">
                        <a href="https://t.me/ROOTLeaker" target="_blank">
                            <i class="fab fa-telegram"></i>
                            کانال تلگرام
                        </a>
                    </div>
                </div>
            </div>
        </footer>

        <div class="modal-overlay" id="auth-modal">
            <div class="modal auth-modal">
                <div class="modal-header">
                    <h3><i class="fas fa-user-circle"></i> ورود / ثبت نام</h3>
                    <button class="modal-close" onclick="closeAuthModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="auth-step-1">
                        <p class="auth-desc">آیدی عددی تلگرام خود را وارد کنید</p>
                        <div class="auth-tip">
                            <i class="fas fa-info-circle"></i>
                            برای دریافت آیدی عددی، به ربات ما پیام /id بفرستید
                        </div>
                        <div class="input-group">
                            <label>آیدی عددی تلگرام</label>
                            <input type="text" id="telegram-id" placeholder="مثال: 123456789" pattern="[0-9]*" inputmode="numeric">
                        </div>
                        <button class="btn btn-primary btn-block" onclick="sendVerifyCode()">
                            <i class="fas fa-paper-plane"></i>
                            ارسال کد تایید
                        </button>
                    </div>
                    <div id="auth-step-2" class="hidden">
                        <p class="auth-desc">کد ۶ رقمی ارسال شده به تلگرام را وارد کنید</p>
                        <div class="input-group">
                            <label>کد تایید</label>
                            <input type="text" id="verify-code" placeholder="مثال: 123456" maxlength="6" pattern="[0-9]*" inputmode="numeric">
                        </div>
                        <button class="btn btn-primary btn-block" onclick="verifyCode()">
                            <i class="fas fa-check"></i>
                            تایید و ورود
                        </button>
                        <button class="btn btn-link" onclick="backToStep1()">
                            <i class="fas fa-arrow-right"></i>
                            بازگشت
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="result-modal">
            <div class="modal">
                <div class="modal-header">
                    <h3 id="result-title"><i class="fas fa-info-circle"></i> نتیجه</h3>
                    <button class="modal-close" onclick="closeResultModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body" id="result-body">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeResultModal()">بستن</button>
                </div>
            </div>
        </div>

        <div class="loading-overlay" id="loading">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <span>در حال پردازش...</span>
            </div>
        </div>

        <div class="toast" id="toast"></div>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        let pendingTelegramId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadAnnouncements();
        });

        async function checkAuth() {
            if (!authToken) {
                updateAuthUI(false);
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    currentUser = data.user;
                    updateAuthUI(true);
                } else {
                    localStorage.removeItem('authToken');
                    authToken = null;
                    updateAuthUI(false);
                }
            } catch (error) {
                updateAuthUI(false);
            }
        }

        function updateAuthUI(isLoggedIn) {
            if (isLoggedIn && currentUser) {
                document.getElementById('auth-buttons').classList.add('hidden');
                document.getElementById('user-menu').classList.remove('hidden');
                document.getElementById('user-display').textContent = currentUser.telegramId;
            } else {
                document.getElementById('auth-buttons').classList.remove('hidden');
                document.getElementById('user-menu').classList.add('hidden');
            }
        }

        async function loadAnnouncements() {
            try {
                const response = await fetch('/api/announcements');
                const data = await response.json();
                if (data.success && data.announcements && data.announcements.length > 0) {
                    const latest = data.announcements[0];
                    const seenAnnouncements = JSON.parse(localStorage.getItem('seenAnnouncements') || '[]');
                    if (!seenAnnouncements.includes(latest.id)) {
                        document.getElementById('announcement-text').textContent = latest.message;
                        document.getElementById('announcement-bar').classList.add('active');
                    }
                }
            } catch (error) {
                console.error('Error loading announcements:', error);
            }
        }

        function closeAnnouncement() {
            const bar = document.getElementById('announcement-bar');
            bar.classList.remove('active');
            const seenAnnouncements = JSON.parse(localStorage.getItem('seenAnnouncements') || '[]');
            seenAnnouncements.push(Date.now().toString());
            localStorage.setItem('seenAnnouncements', JSON.stringify(seenAnnouncements.slice(-10)));
        }

        async function checkMyIP() {
            showLoading();
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                
                document.getElementById('result-title').innerHTML = '<i class="fas fa-globe-americas" style="color: var(--secondary);"></i> آی‌پی شما';
                document.getElementById('result-body').innerHTML = `
                    <div class="ip-result">
                        <div class="ip-address">${data.ip}</div>
                        <p>این آی‌پی که اینترنت با آن شما را می‌شناسد</p>
                    </div>
                `;
                document.getElementById('result-modal').classList.add('active');
            } catch (error) {
                showToast('خطا در دریافت اطلاعات', 'error');
            } finally {
                hideLoading();
            }
        }

        async function testDnsSpeed() {
            showLoading();
            
            const dnsServers = [
                { name: 'Cloudflare', ip: '1.1.1.1' },
                { name: 'Google', ip: '8.8.8.8' },
                { name: 'Quad9', ip: '9.9.9.9' },
                { name: 'OpenDNS', ip: '208.67.222.222' }
            ];

            let results = '<div class="dns-results">';
            
            for (const dns of dnsServers) {
                const start = performance.now();
                try {
                    await fetch(`https://${dns.ip === '1.1.1.1' ? 'cloudflare-dns.com' : 'dns.google'}/dns-query`, {
                        method: 'HEAD',
                        mode: 'no-cors'
                    });
                    const time = Math.round(performance.now() - start);
                    results += `
                        <div class="dns-item">
                            <span class="dns-name">${dns.name}</span>
                            <span class="dns-ip">${dns.ip}</span>
                            <span class="dns-time ${time < 100 ? 'fast' : time < 300 ? 'medium' : 'slow'}">${time}ms</span>
                        </div>
                    `;
                } catch {
                    results += `
                        <div class="dns-item">
                            <span class="dns-name">${dns.name}</span>
                            <span class="dns-ip">${dns.ip}</span>
                            <span class="dns-time">-</span>
                        </div>
                    `;
                }
            }
            
            results += '</div>';

            document.getElementById('result-title').innerHTML = '<i class="fas fa-tachometer-alt" style="color: var(--secondary);"></i> تست سرعت DNS';
            document.getElementById('result-body').innerHTML = results;
            document.getElementById('result-modal').classList.add('active');
            hideLoading();
        }

        function checkDnsLeak() {
            document.getElementById('result-title').innerHTML = '<i class="fas fa-shield-virus" style="color: var(--secondary);"></i> بررسی نشتی DNS';
            document.getElementById('result-body').innerHTML = `
                <div class="leak-info">
                    <p>برای بررسی دقیق نشتی DNS، از سایت‌های زیر استفاده کنید:</p>
                    <div class="leak-links">
                        <a href="https://www.dnsleaktest.com" target="_blank" class="btn btn-outline">
                            <i class="fas fa-external-link-alt"></i>
                            DNS Leak Test
                        </a>
                        <a href="https://ipleak.net" target="_blank" class="btn btn-outline">
                            <i class="fas fa-external-link-alt"></i>
                            IP Leak
                        </a>
                    </div>
                </div>
            `;
            document.getElementById('result-modal').classList.add('active');
        }

        function showQrGenerator() {
            document.getElementById('result-title').innerHTML = '<i class="fas fa-qrcode" style="color: var(--secondary);"></i> ساخت QR Code';
            document.getElementById('result-body').innerHTML = `
                <div class="qr-generator">
                    <p>کانفیگ WireGuard را وارد کنید:</p>
                    <textarea id="qr-config" class="qr-input" placeholder="[Interface]&#10;PrivateKey = ..."></textarea>
                    <button class="btn btn-primary" onclick="generateQR()">
                        <i class="fas fa-qrcode"></i>
                        ساخت QR Code
                    </button>
                    <div id="qr-output"></div>
                </div>
            `;
            document.getElementById('result-modal').classList.add('active');
        }

        function generateQR() {
            const config = document.getElementById('qr-config').value;
            if (!config.trim()) {
                showToast('لطفا کانفیگ را وارد کنید', 'error');
                return;
            }
            
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(config)}`;
            document.getElementById('qr-output').innerHTML = `
                <img src="${qrUrl}" alt="QR Code" class="qr-image">
                <p>این کد را با اپلیکیشن WireGuard اسکن کنید</p>
            `;
        }

        function checkPing() {
            document.getElementById('result-title').innerHTML = '<i class="fas fa-clock" style="color: var(--secondary);"></i> بررسی پینگ';
            document.getElementById('result-body').innerHTML = `
                <div class="ping-info">
                    <p>برای بررسی دقیق پینگ، از ترمینال استفاده کنید:</p>
                    <div class="code-block">
                        <code>ping 1.1.1.1</code>
                    </div>
                    <p>یا از سایت‌های آنلاین:</p>
                    <a href="https://ping.pe" target="_blank" class="btn btn-outline">
                        <i class="fas fa-external-link-alt"></i>
                        Ping.pe
                    </a>
                </div>
            `;
            document.getElementById('result-modal').classList.add('active');
        }

        function showGuide() {
            document.getElementById('result-title').innerHTML = '<i class="fas fa-book" style="color: var(--secondary);"></i> راهنمای نصب';
            document.getElementById('result-body').innerHTML = `
                <div class="guide-content">
                    <h4><i class="fab fa-android"></i> اندروید</h4>
                    <ol>
                        <li>WireGuard را از Play Store نصب کنید</li>
                        <li>کانفیگ را از سایت ما دریافت کنید</li>
                        <li>روی + کلیک کرده و "Import from file" بزنید</li>
                    </ol>
                    
                    <h4><i class="fab fa-apple"></i> iOS</h4>
                    <ol>
                        <li>WireGuard را از App Store نصب کنید</li>
                        <li>QR Code کانفیگ را اسکن کنید</li>
                    </ol>
                    
                    <h4><i class="fab fa-windows"></i> ویندوز</h4>
                    <ol>
                        <li>WireGuard را از wireguard.com دانلود کنید</li>
                        <li>فایل .conf را Import کنید</li>
                        <li>روی Activate کلیک کنید</li>
                    </ol>
                </div>
            `;
            document.getElementById('result-modal').classList.add('active');
        }

        function closeResultModal() {
            document.getElementById('result-modal').classList.remove('active');
        }

        function showAuthModal() {
            document.getElementById('auth-modal').classList.add('active');
            document.getElementById('auth-step-1').classList.remove('hidden');
            document.getElementById('auth-step-2').classList.add('hidden');
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').classList.remove('active');
        }

        function backToStep1() {
            document.getElementById('auth-step-1').classList.remove('hidden');
            document.getElementById('auth-step-2').classList.add('hidden');
        }

        async function sendVerifyCode() {
            const telegramId = document.getElementById('telegram-id').value.trim();

            if (!telegramId || !/^\d{5,15}$/.test(telegramId)) {
                showToast('لطفا آیدی عددی معتبر وارد کنید', 'error');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/api/auth/send-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId })
                });

                const data = await response.json();

                if (data.success) {
                    pendingTelegramId = telegramId;
                    document.getElementById('auth-step-1').classList.add('hidden');
                    document.getElementById('auth-step-2').classList.remove('hidden');
                    showToast('کد تایید ارسال شد', 'success');
                } else {
                    showToast(data.error || 'خطا در ارسال کد', 'error');
                }
            } catch (error) {
                showToast('خطا در ارتباط با سرور', 'error');
            } finally {
                hideLoading();
            }
        }

        async function verifyCode() {
            const code = document.getElementById('verify-code').value.trim();

            if (!code || code.length !== 6) {
                showToast('لطفا کد ۶ رقمی را وارد کنید', 'error');
                return;
            }

            showLoading();

            try {
                const response = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ telegramId: pendingTelegramId, code })
                });

                const data = await response.json();

                if (data.success) {
                    authToken = data.token;
                    currentUser = data.user;
                    localStorage.setItem('authToken', authToken);
                    closeAuthModal();
                    updateAuthUI(true);
                    showToast('ورود موفق!', 'success');
                } else {
                    showToast(data.error || 'کد تایید اشتباه است', 'error');
                }
            } catch (error) {
                showToast('خطا در ارتباط با سرور', 'error');
            } finally {
                hideLoading();
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            authToken = null;
            currentUser = null;
            updateAuthUI(false);
            showToast('خارج شدید', 'success');
        }

        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;
            setTimeout(() => toast.classList.remove('active'), 3000);
        }

        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
