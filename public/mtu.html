<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MTU Tester</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/components.css">
<link rel="stylesheet" href="/css/animations.css">
<style>
.mtu-container {
  max-width: 480px;
  margin: 0 auto;
  padding: 20px 16px;
}

.mtu-header {
  text-align: center;
  margin-bottom: 24px;
}

.mtu-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.mtu-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
}

.mtu-input-section {
  margin-bottom: 16px;
}

.mtu-label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.mtu-input {
  width: 100%;
  padding: 14px 16px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-size: 16px;
  font-family: inherit;
  transition: var(--transition);
  direction: ltr;
  text-align: left;
}

.mtu-input:focus {
  outline: none;
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2);
}

.mtu-divider {
  height: 1px;
  background: var(--separator);
  margin: 20px 0;
}

.mtu-section-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--accent-blue);
  margin-bottom: 12px;
}

.mtu-button-group {
  display: flex;
  gap: 12px;
  margin-top: 16px;
  flex-wrap: wrap;
}

.mtu-status-box {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 20px;
  margin-top: 20px;
  text-align: center;
}

.mtu-status-label {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  margin-bottom: 8px;
}

.mtu-status-text {
  font-size: 17px;
  font-weight: 600;
  color: var(--text-primary);
  margin-top: 8px;
}

.mtu-status-loading {
  color: var(--accent-orange);
}

.mtu-status-ok {
  color: var(--accent-green);
}

.mtu-status-err {
  color: var(--accent-red);
}

.mtu-table-container {
  max-height: 300px;
  overflow-y: auto;
  margin-top: 20px;
  border-radius: var(--radius-md);
  border: 1px solid var(--border-color);
}

.mtu-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 14px;
}

.mtu-table thead th {
  position: sticky;
  top: 0;
  background: var(--bg-secondary);
  z-index: 10;
  border-bottom: 2px solid var(--accent-blue);
  padding: 12px 16px;
  text-align: center;
  color: var(--text-secondary);
  font-weight: 600;
}

.mtu-table tbody td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--separator);
  text-align: center;
}

.mtu-table tbody tr:last-child td {
  border-bottom: none;
}

.mtu-table tbody tr:nth-child(even) {
  background: rgba(255, 255, 255, 0.02);
}

.mtu-table tbody tr:hover {
  background: rgba(255, 255, 255, 0.08);
}

.mtu-summary-box {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-color);
  border-radius: var(--radius-md);
  padding: 16px;
  margin-top: 20px;
}

.mtu-summary-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--accent-blue);
  margin-bottom: 12px;
}

.mtu-summary-text {
  font-size: 14px;
  color: var(--text-primary);
  line-height: 1.8;
}

.mtu-counter {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 8px;
}

.res-success {
  color: var(--accent-green);
}

.res-fail {
  color: var(--accent-red);
}

@media(max-width: 600px) {
  .mtu-button-group {
    flex-direction: column;
  }

  .mtu-title {
    font-size: 20px;
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeOut {
  from {
    opacity: 1;
  }
  to {
    opacity: 0;
  }
}
</style>
</head>
<body>

<div id="toast-container" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;"></div>

<div class="mtu-container">
  <button class="btn btn-secondary" onclick="goBackToTools()" style="margin-bottom: 20px;">
    â†’ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§
  </button>
  <div class="mtu-header">
    <h1 class="mtu-title">ØªØ³ØªØ± Ù¾ÛŒØ´Ø±ÙØªÙ‡ MTU</h1>
    <p class="mtu-subtitle">Ø¢Ø²Ù…Ø§ÛŒØ´ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ø¨Ù‡ÛŒÙ†Ù‡ Ø¨Ø³ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø´Ø¨Ú©Ù‡</p>
  </div>

  <div class="card">
    <div class="mtu-input-section">
      <label class="mtu-label" id="labelService">Ø¢Ø¯Ø±Ø³ Ø³Ø±ÙˆÛŒØ³ (Payload Generator URL)</label>
      <input class="mtu-input" id="serviceURL" type="text" value="https://httpbin.org/bytes/" />
    </div>

    <div class="mtu-input-section">
      <label class="mtu-label" id="labelSize">Ø³Ø§ÛŒØ² Ø¨Ø³ØªÙ‡ (Ø¨Ø§ÛŒØª) - ØªØ³Øª ØªÚ©ÛŒ</label>
      <input class="mtu-input" id="size" type="number" value="1472" />
    </div>

    <div class="mtu-divider"></div>

    <h4 class="mtu-section-title">ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø± (Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¨Ø§ÛŒÙ†Ø±ÛŒ)</h4>

    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
      <div style="flex: 1;">
        <label class="mtu-label" id="labelMinSize">Ø´Ø±ÙˆØ¹ Ø¬Ø³ØªØ¬Ùˆ (Min)</label>
        <input class="mtu-input" id="minSize" type="number" value="500" />
      </div>
      <div style="flex: 1;">
        <label class="mtu-label" id="labelMaxSize">Ù¾Ø§ÛŒØ§Ù† Ø¬Ø³ØªØ¬Ùˆ (Max)</label>
        <input class="mtu-input" id="maxSize" type="number" value="1500" />
      </div>
    </div>

    <div class="mtu-button-group">
      <button class="btn btn-primary" id="run">Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª ØªÚ©ÛŒ</button>
      <button class="btn btn-secondary" id="auto">ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø± (Ù‡ÙˆØ´Ù…Ù†Ø¯)</button>
      <button class="btn btn-danger" id="clear">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button>
    </div>

    <div class="mtu-status-box">
      <div class="mtu-status-label" id="strongStatus">ÙˆØ¶Ø¹ÛŒØª Ù„Ø­Ø¸Ù‡â€ŒØ§ÛŒ:</div>
      <div class="mtu-status-text" id="liveStatus" style="color:var(--text-secondary)">Ù…Ù†ØªØ¸Ø± Ø¯Ø³ØªÙˆØ±...</div>
      <div class="mtu-counter" id="testCounter"></div>
    </div>

    <div class="mtu-table-container">
      <table class="mtu-table" id="results">
        <thead>
          <tr>
            <th id="thSize">Ø³Ø§ÛŒØ²</th>
            <th id="thResult">Ù†ØªÛŒØ¬Ù‡</th>
            <th id="thTime">Ø²Ù…Ø§Ù† (ms)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="mtu-summary-box" id="summaryBox" style="display:none;">
      <h4 class="mtu-summary-title">ğŸ“Š Ù†ØªØ§ÛŒØ¬ ØªØ­Ù„ÛŒÙ„</h4>
      <div class="mtu-summary-text" id="summaryText"></div>
    </div>
  </div>
</div>

<script>
const state = {
    isRunning: false,
    results: [],
    testCount: 0,
    singleTestUsed: false,
    autoTestUsed: false
};

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    
    const bgColors = {
        success: 'var(--accent-green)',
        error: 'var(--accent-red)',
        info: 'var(--accent-blue)',
        warning: 'var(--accent-orange)'
    };
    
    toast.style.cssText = `
        background: ${bgColors[type] || bgColors.info};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: slideDown 0.3s ease;
    `;
    toast.textContent = message;
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function goBackToTools() {
    localStorage.setItem('wg_dns_active_tab', 'tools');
    window.location.href = '/';
}

async function checkUsageLimit() {
    const token = localStorage.getItem('wg_dns_token');
    
    if (!token) {
        showToast('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'warning');
        setTimeout(() => {
            localStorage.setItem('wg_dns_active_tab', 'tools');
            window.location.href = '/';
        }, 2000);
        return;
    }
    
    try {
        const response = await fetch('/api/tools/mtu-usage', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            state.singleTestUsed = data.singleTestUsed || false;
            state.autoTestUsed = data.autoTestUsed || false;
            return data;
        }
        
        return { singleTestUsed: false, autoTestUsed: false };
    } catch (error) {
        console.log('Usage check error:', error);
        return { singleTestUsed: false, autoTestUsed: false };
    }
}

async function recordTest(testType) {
    const token = localStorage.getItem('wg_dns_token');
    if (!token) {
        showToast('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', 'warning');
        return { success: false };
    }
    
    try {
        const response = await fetch('/api/tools/mtu-test', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ testType })
        });
        
        if (response.status === 429) {
            const error = await response.json();
            showToast(error.error || 'Ø´Ù…Ø§ Ø§Ù…Ø±ÙˆØ² Ø§Ø² Ø§ÛŒÙ† ØªØ³Øª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯', 'warning');
            return { success: false, limitReached: true };
        }
        
        if (!response.ok) {
            return { success: true };
        }
        
        return await response.json();
    } catch (error) {
        console.log('Record test error:', error);
        return { success: true };
    }
}

window.addEventListener('load', checkUsageLimit);

const el = (id) => document.getElementById(id);
const ui = {
    serviceURL: el('serviceURL'),
    sizeInput: el('size'),
    minSizeInput: el('minSize'),
    maxSizeInput: el('maxSize'),
    runBtn: el('run'),
    autoBtn: el('auto'),
    clearBtn: el('clear'),
    statusText: el('liveStatus'),
    testCounter: el('testCounter'),
    tableBody: el('results').querySelector('tbody'),
    summaryBox: el('summaryBox'),
    summaryText: el('summaryText')
};

async function fetchPayload(size) {
    const url = ui.serviceURL.value;
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000); 

    const start = performance.now();
    try {
        const targetUrl = `${url}${size}?_t=${Date.now()}`;
        const response = await fetch(targetUrl, { 
            signal: controller.signal,
            cache: "no-store",
            mode: 'cors' 
        });

        clearTimeout(timeoutId);
        const end = performance.now();

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const blob = await response.blob();
        if (blob.size !== parseInt(size)) throw new Error("Size Mismatch");

        return { success: true, time: (end - start).toFixed(0) };
    } catch (err) {
        return { success: false, error: err.name === 'AbortError' ? 'Timeout' : err.message };
    }
}

function logResult(size, result) {
    const tr = document.createElement('tr');

    let statusHtml = '';
    if (result.success) {
        statusHtml = `<span class="res-success">âœ” Ù…ÙˆÙÙ‚</span>`;
    } else {
        const msg = result.error === 'Timeout' ? 'Timeout' : 'Ù†Ø§Ù…ÙˆÙÙ‚';
        statusHtml = `<span class="res-fail">âœ˜ ${msg}</span>`;
    }

    tr.innerHTML = `
        <td style="font-family:monospace; font-weight:bold;">${size}</td>
        <td>${statusHtml}</td>
        <td dir="ltr">${result.time ? result.time : '-'}</td>
    `;

    ui.tableBody.prepend(tr);

    ui.statusText.innerHTML = result.success ? 
        `<span class="mtu-status-ok">Ù…ÙˆÙÙ‚: ${size} Ø¨Ø§ÛŒØª</span>` : 
        `<span class="mtu-status-err">Ù†Ø§Ù…ÙˆÙÙ‚: ${size} Ø¨Ø§ÛŒØª</span>`;

    return result.success;
}

async function runSingleTest() {
    if (state.isRunning) return stopTest();

    if (state.singleTestUsed) {
        showToast('Ø´Ù…Ø§ Ø§Ù…Ø±ÙˆØ² Ø§Ø² ØªØ³Øª ØªÚ©ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ ÙØ±Ø¯Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'warning');
        return;
    }

    const size = parseInt(ui.sizeInput.value);
    if (!size || size < 1) {
        showToast('Ø³Ø§ÛŒØ² Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', 'error');
        return;
    }

    const recordResult = await recordTest('single');
    if (recordResult.limitReached) {
        state.singleTestUsed = true;
        return;
    }
    if (!recordResult.success && !recordResult.limitReached) {
        return;
    }
    state.singleTestUsed = true;

    setRunningState(true);
    ui.statusText.innerText = `Ø¯Ø±Ø­Ø§Ù„ ØªØ³Øª ${size} Ø¨Ø§ÛŒØª...`;
    ui.statusText.className = 'mtu-status-text mtu-status-loading';

    const result = await fetchPayload(size);
    logResult(size, result);
    setRunningState(false);
}

async function runAutoTest() {
    if (state.isRunning) return stopTest();

    if (state.autoTestUsed) {
        showToast('Ø´Ù…Ø§ Ø§Ù…Ø±ÙˆØ² Ø§Ø² ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ ÙØ±Ø¯Ø§ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'warning');
        return;
    }

    let min = parseInt(ui.minSizeInput.value) || 500;
    let max = parseInt(ui.maxSizeInput.value) || 1500;

    if (min >= max || min < 1 || max > 9000) {
        showToast('Ù„Ø·ÙØ§Ù‹ Ø¨Ø§Ø²Ù‡ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø¹ØªØ¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
        return;
    }

    const recordResult = await recordTest('auto');
    if (recordResult.limitReached) {
        state.autoTestUsed = true;
        return;
    }
    if (!recordResult.success && !recordResult.limitReached) {
        return;
    }
    state.autoTestUsed = true;

    setRunningState(true);
    ui.tableBody.innerHTML = ''; 
    let optimalPayload = 0;

    const totalTests = Math.ceil(Math.log2(max - min)) + 1;
    state.testCount = 0; 

    let currentMin = min;
    let currentMax = max;

    while (currentMin <= currentMax && state.isRunning) {
        let mid = Math.floor((currentMin + currentMax) / 2);

        state.testCount++;
        ui.statusText.innerText = `Ø¯Ø±Ø­Ø§Ù„ ØªØ³Øª ${mid} Ø¨Ø§ÛŒØª...`;
        ui.statusText.className = 'mtu-status-text mtu-status-loading';
        ui.testCounter.innerText = `ØªØ³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡: ${state.testCount} Ø§Ø² ${totalTests} (ØªØ®Ù…ÛŒÙ†)`;

        let success = await doTestStep(mid);

        if (success) {
            optimalPayload = mid;
            currentMin = mid + 1;
        } else {
            currentMax = mid - 1;
        }

        await new Promise(r => setTimeout(r, 500));
    }

    if (state.isRunning) {
        showSummary(optimalPayload);
        ui.testCounter.innerText = '';
        setRunningState(false);
    }
}

async function doTestStep(size) {
    const result = await fetchPayload(size);
    logResult(size, result);
    return result.success;
}

function getClassification(mtu) {
    if (mtu > 1528) {
        return 'ÙˆØ¶Ø¹ÛŒØª: ğŸŸ  Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ (Jumbo Frame ÛŒØ§ Ù…Ø´Ú©Ù„ Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ)';
    } else if (mtu <= 1500 && mtu >= 1400) {
        return 'ÙˆØ¶Ø¹ÛŒØª: ğŸŸ¢ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø§ØªØ±Ù†Øª (1500)';
    } else if (mtu < 1400) {
        return 'ÙˆØ¶Ø¹ÛŒØª: ğŸ”´ Ø¨Ø³ÛŒØ§Ø± Ú©ÙˆÚ†Ú© (Ø§Ø­ØªÙ…Ø§Ù„ ÙˆØ¬ÙˆØ¯ ÙØ§ÛŒØ±ÙˆØ§Ù„ ÛŒØ§ Ù…Ø´Ú©Ù„ Fragmentation)';
    }
    return '';
}

function showSummary(maxPayload) {
    if(maxPayload === 0) return;

    ui.summaryBox.style.display = 'block';
    const estimatedMTU = maxPayload + 28; 
    const classificationText = getClassification(estimatedMTU);

    ui.summaryText.innerHTML = `
        Ø¨Ø²Ø±Ú¯ØªØ±ÛŒÙ† Ø¨Ø³ØªÙ‡ Ù…ÙˆÙÙ‚: <strong>${maxPayload} Ø¨Ø§ÛŒØª</strong><br>
        MTU Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ (ØªØ®Ù…ÛŒÙ†): <strong>${estimatedMTU}</strong><br>
        <span style="font-size:13px; font-weight:normal;">${classificationText}</span>
    `;
}

function setRunningState(running) {
    state.isRunning = running;

    if (running) {
        ui.runBtn.innerText = 'ØªÙˆÙ‚Ù ØªØ³Øª';
        ui.autoBtn.innerText = 'ØªÙˆÙ‚Ù ØªØ³Øª';
        ui.runBtn.classList.remove('btn-primary');
        ui.runBtn.classList.add('btn-danger');
        ui.autoBtn.classList.remove('btn-secondary');
        ui.autoBtn.classList.add('btn-danger');
        ui.sizeInput.disabled = true;
        ui.serviceURL.disabled = true;
        ui.minSizeInput.disabled = true;
        ui.maxSizeInput.disabled = true;
    } else {
        ui.runBtn.innerText = 'Ø§Ø¬Ø±Ø§ÛŒ ØªØ³Øª ØªÚ©ÛŒ';
        ui.autoBtn.innerText = 'ØªØ³Øª Ø®ÙˆØ¯Ú©Ø§Ø± (Ù‡ÙˆØ´Ù…Ù†Ø¯)';
        ui.runBtn.classList.remove('btn-danger');
        ui.runBtn.classList.add('btn-primary');
        ui.autoBtn.classList.remove('btn-danger');
        ui.autoBtn.classList.add('btn-secondary');
        ui.sizeInput.disabled = false;
        ui.serviceURL.disabled = false;
        ui.minSizeInput.disabled = false;
        ui.maxSizeInput.disabled = false;
        ui.statusText.innerText = 'Ù…Ù†ØªØ¸Ø± Ø¯Ø³ØªÙˆØ±...';
        ui.statusText.className = 'mtu-status-text';
        ui.testCounter.innerText = '';
    }
}

function stopTest() {
    setRunningState(false);
    ui.statusText.innerText = "ØªÙˆÙ‚Ù ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±";
}

function clearResults() {
    ui.tableBody.innerHTML = '';
    ui.summaryBox.style.display = 'none';
    ui.statusText.innerText = 'Ù…Ù†ØªØ¸Ø± Ø¯Ø³ØªÙˆØ±...';
    ui.testCounter.innerText = '';
}

ui.runBtn.onclick = runSingleTest;
ui.autoBtn.onclick = runAutoTest;
ui.clearBtn.onclick = clearResults;
</script>

</body>
</html>
